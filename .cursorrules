---
description: "Gu√≠a de desarrollo Frontend (Flutter) para Zonix Eats"
alwaysApply: true
---

## üéØ ESTADO ACTUAL DEL PROYECTO

**Versi√≥n:** 1.0.0  
**Flutter SDK:** >=3.5.0 <4.0.0  
**Dart:** 3.5.0+  
**Estado:** ‚úÖ MVP Completado - En desarrollo activo  
**Archivos Dart:** 177 archivos (verificado)  
**L√≠neas de c√≥digo:** 58,987 l√≠neas Dart en `lib/` (verificado)  
**Tests:** 214 tests pasaron ‚úÖ, 0 tests fallaron ‚úÖ (incl. onboarding: payload schedule string, testWidgets con pump)  
**Errores cr√≠ticos:** ‚úÖ Todos corregidos (FlutterSecureStorage BAD_DECRYPT, AdminDashboardPage null safety, roles limpiados, dashboard optimizado)  
**TODOs servicios MVP:** ‚úÖ Completados (commerce, payment, delivery, chat, admin, analytics, location, notification; c√≥digo comentado eliminado)  
**√öltima actualizaci√≥n:** 11 Febrero 2025

---

## REGLAS FUNDAMENTALES DE COLABORACI√ìN

**IMPORTANTE: El usuario es el l√≠der del proyecto. El asistente debe:**

1. **SIEMPRE PREGUNTAR** antes de realizar cualquier acci√≥n
2. **NUNCA crear archivos nuevos** si es para editar c√≥digo existente
3. **SIEMPRE sugerir detalladamente** qu√© hacer y esperar aprobaci√≥n
4. **NUNCA hacer push a git** sin orden expl√≠cita del usuario
5. **NUNCA hacer merge a git** sin orden expl√≠cita del usuario
6. **El usuario tiene el mando** - el asistente sugiere, el usuario decide

**Flujo de trabajo:**
- Asistente: "Sugiero hacer X, ¬øquieres que proceda?"
- Usuario: "S√≠, hazlo" o "No, mejor Y"
- Asistente: Ejecuta solo lo aprobado

**CR√çTICO - Control de Git:**
- ‚ùå **NUNCA hacer push autom√°ticamente** - Solo cuando el usuario lo ordene expl√≠citamente
- ‚ùå **NUNCA hacer merge autom√°ticamente** - Solo cuando el usuario lo ordene expl√≠citamente
- ‚úÖ **Solo hacer commits locales** cuando se realicen cambios
- ‚úÖ **Esperar aprobaci√≥n del usuario** antes de cualquier push o merge
- ‚úÖ **El usuario prueba primero** y da la orden cuando est√° seguro

---

## ARQUITECTURA Y ESTRUCTURA

### Estructura del Proyecto

```
zonix-eats-front/
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app_config.dart          # Configuraci√≥n central
‚îÇ   ‚îú‚îÄ‚îÄ features/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ screens/                 # 30+ pantallas
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ products/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ orders/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ restaurants/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commerce/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ delivery/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                 # 50+ servicios
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ cart_service.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order_service.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commerce_service.dart
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pusher_service.dart    # Tiempo real (Pusher). websocket_service.dart es legacy/placeholder
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DomainProfiles/           # M√≥dulos de perfiles
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Profiles/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Addresses/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ Documents/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ Phones/
‚îÇ   ‚îú‚îÄ‚îÄ models/                       # Modelos de datos
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ order.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ product.dart
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ commerce.dart
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ   ‚îú‚îÄ‚îÄ helpers/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ auth_helper.dart
‚îÇ   ‚îî‚îÄ‚îÄ main.dart                     # Punto de entrada
‚îú‚îÄ‚îÄ assets/                           # Recursos est√°ticos
‚îú‚îÄ‚îÄ test/                             # Tests
‚îî‚îÄ‚îÄ pubspec.yaml                      # Dependencias
```

### Patr√≥n Arquitect√≥nico

**Feature-based Architecture con Provider Pattern:**
- **Screens:** Pantallas de la aplicaci√≥n
- **Services:** L√≥gica de comunicaci√≥n con API
- **Models:** Modelos de datos
- **Providers:** State management (Provider pattern)
- **Utils:** Utilidades y helpers

**Principios a seguir:**
- ‚úÖ Separation of Concerns
- ‚úÖ Single Responsibility Principle
- ‚úÖ DRY (Don't Repeat Yourself)
- ‚úÖ Feature-based organization

---

## CONVENCIONES DE C√ìDIGO

### Nomenclatura

- **Archivos:** snake_case (ej: `cart_service.dart`)
- **Clases:** PascalCase (ej: `CartService`)
- **Variables:** lowerCamelCase (ej: `orderId`)
- **Constantes:** UPPER_SNAKE_CASE (ej: `API_BASE_URL`)
- **Widgets:** PascalCase con sufijo descriptivo (ej: `ProductCard`, `OrderListItem`)

### Estructura de Servicios

```dart
import 'package:flutter/foundation.dart';
import 'package:http/http.dart' as http;
import '../../config/app_config.dart';
import '../../helpers/auth_helper.dart';

class OrderService extends ChangeNotifier {
  final String _baseUrl = AppConfig.apiUrl;
  
  Future<List<Order>> getOrders() async {
    try {
      final headers = await AuthHelper.getAuthHeaders();
      final url = Uri.parse('$_baseUrl/api/buyer/orders');
      
      final response = await http.get(url, headers: headers);
      
      if (response.statusCode == 200) {
        final data = jsonDecode(response.body);
        if (data['success'] == true && data['data'] != null) {
          return (data['data'] as List)
              .map((json) => Order.fromJson(json))
              .toList();
        }
      }
      throw Exception('Error al obtener √≥rdenes');
    } catch (e) {
      throw Exception('Error: $e');
    }
  }
}
```

### Estructura de Pantallas

```dart
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../services/order_service.dart';

class OrdersPage extends StatefulWidget {
  const OrdersPage({super.key});

  @override
  State<OrdersPage> createState() => _OrdersPageState();
}

class _OrdersPageState extends State<OrdersPage> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      context.read<OrderService>().loadOrders();
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: const Text('Mis √ìrdenes')),
      body: Consumer<OrderService>(
        builder: (context, orderService, child) {
          if (orderService.isLoading) {
            return const Center(child: CircularProgressIndicator());
          }
          
          if (orderService.orders.isEmpty) {
            return const Center(child: Text('No hay √≥rdenes'));
          }
          
          return ListView.builder(
            itemCount: orderService.orders.length,
            itemBuilder: (context, index) {
              final order = orderService.orders[index];
              return OrderListItem(order: order);
            },
          );
        },
      ),
    );
  }
}
```

### Modelos de Datos

```dart
class Order {
  final int id;
  final int userId;
  final int commerceId;
  final String status;
  final double total;
  final DateTime createdAt;
  final List<OrderItem> items;

  Order({
    required this.id,
    required this.userId,
    required this.commerceId,
    required this.status,
    required this.total,
    required this.createdAt,
    required this.items,
  });

  factory Order.fromJson(Map<String, dynamic> json) {
    return Order(
      id: json['id'],
      userId: json['user_id'],
      commerceId: json['commerce_id'],
      status: json['status'],
      total: (json['total'] ?? 0.0).toDouble(),
      createdAt: DateTime.parse(json['created_at']),
      items: (json['items'] as List?)
          ?.map((item) => OrderItem.fromJson(item))
          .toList() ?? [],
    );
  }

  Map<String, dynamic> toJson() {
    return {
      'id': id,
      'user_id': userId,
      'commerce_id': commerceId,
      'status': status,
      'total': total,
      'created_at': createdAt.toIso8601String(),
      'items': items.map((item) => item.toJson()).toList(),
    };
  }

  Order copyWith({
    int? id,
    int? userId,
    int? commerceId,
    String? status,
    double? total,
    DateTime? createdAt,
    List<OrderItem>? items,
  }) {
    return Order(
      id: id ?? this.id,
      userId: userId ?? this.userId,
      commerceId: commerceId ?? this.commerceId,
      status: status ?? this.status,
      total: total ?? this.total,
      createdAt: createdAt ?? this.createdAt,
      items: items ?? this.items,
    );
  }
}
```

---

## STATE MANAGEMENT

### Provider Pattern

**Uso de Provider:**
```dart
// En main.dart
MultiProvider(
  providers: [
    ChangeNotifierProvider(create: (_) => UserProvider()),
    ChangeNotifierProvider(create: (_) => CartService()),
    ChangeNotifierProvider(create: (_) => OrderService()),
    // ...
  ],
  child: MyApp(),
)

// En pantalla
Consumer<CartService>(
  builder: (context, cartService, child) {
    return Text('Items: ${cartService.items.length}');
  },
)

// O con Provider.of
final cartService = Provider.of<CartService>(context, listen: false);
```

**Reglas:**
- ‚úÖ Usar `Consumer` cuando necesites rebuilds autom√°ticos
- ‚úÖ Usar `Provider.of` con `listen: false` para acciones √∫nicas
- ‚úÖ Notificar cambios con `notifyListeners()` en servicios

---

## COMUNICACI√ìN CON API

### Configuraci√≥n de URLs

**SIEMPRE usar AppConfig:**
```dart
import '../../config/app_config.dart';

final url = Uri.parse('${AppConfig.apiUrl}/api/buyer/orders');
```

**NO hardcodear URLs:**
```dart
// ‚ùå MAL
final url = Uri.parse('http://192.168.27.12:8000/api/orders');

// ‚úÖ BIEN
final url = Uri.parse('${AppConfig.apiUrl}/api/buyer/orders');
```

### Headers de Autenticaci√≥n

**SIEMPRE usar AuthHelper:**
```dart
import '../../helpers/auth_helper.dart';

final headers = await AuthHelper.getAuthHeaders();
```

### Manejo de Errores

```dart
try {
  final response = await http.get(url, headers: headers);
  
  if (response.statusCode == 200) {
    final data = jsonDecode(response.body);
    if (data['success'] == true) {
      return data['data'];
    } else {
      throw Exception(data['message'] ?? 'Error desconocido');
    }
  } else if (response.statusCode == 401) {
    // Token expirado - redirigir a login
    await _handleUnauthorized();
    throw Exception('Sesi√≥n expirada');
  } else {
    throw Exception('Error ${response.statusCode}');
  }
} catch (e) {
  logger.e('Error en API: $e');
  rethrow;
}
```

### Estructura de Respuestas

**Formato esperado del backend:**
```json
{
  "success": true,
  "data": { ... },
  "message": "Operaci√≥n exitosa"
}
```

**Manejo:**
```dart
if (data['success'] == true && data['data'] != null) {
  return processData(data['data']);
} else {
  throw Exception(data['message'] ?? 'Error');
}
```

---

## EVENTOS Y NOTIFICACIONES EN TIEMPO REAL

### Firebase + Pusher (NO WebSocket)

**‚úÖ IMPLEMENTADO:** Firebase Cloud Messaging (FCM) + Pusher para notificaciones en tiempo real

**Eventos disponibles:**
- `OrderCreated` - Nueva orden creada
- `OrderStatusChanged` - Estado de orden cambiado
- `PaymentValidated` - Pago validado
- `NewMessage` - Nuevo mensaje de chat
- `DeliveryLocationUpdated` - Ubicaci√≥n de delivery actualizada
- `NotificationCreated` - Nueva notificaci√≥n

**Canales (Pusher):**
- `private-user.{userId}` - Notificaciones de usuario
- `private-order.{orderId}` - Actualizaciones de orden
- `private-chat.{orderId}` - Chat de orden
- `private-commerce.{commerceId}` - Notificaciones de comercio

**IMPORTANTE:** NO usar WebSocket directamente. Usar Firebase + Pusher para notificaciones en tiempo real.

---

## ROLES Y NAVEGACI√ìN

### Roles del Sistema (MVP)

**Roles implementados y funcionales:**
- **users** (Level 0): Cliente/Comprador ‚úÖ
- **commerce** (Level 1): Comercio/Restaurante ‚úÖ
- **delivery** (Level 2): Repartidor/Delivery ‚úÖ (con jerarqu√≠a: Delivery Company y Delivery Agent)
- **admin** (Level 3): Administrador ‚úÖ

**IMPORTANTE:** Solo existen estos 4 roles. Los roles `transport` y `affiliate` fueron eliminados del c√≥digo y del dashboard (niveles 3 y 4 eliminados, admin movido a nivel 3).

### Datos Requeridos por Rol

**USERS (Comprador):**
- **M√≠nimos para orden:** firstName, lastName, phone, photo_users (required)
- **Direcciones:** 2 direcciones (predeterminada casa con `is_default=true` + direcci√≥n de entrega)
- **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n
- **Campos direcci√≥n:** street, house_number, postal_code, latitude, longitude, city_id, is_default

**COMMERCE (Vendedor):**
- **Requeridos:** 7 campos (firstName, lastName, phone, address, business_name, business_type, tax_id)
- **Opcionales:** 16 campos (6 del perfil, 5 del comercio, 3 relaciones, 2 del sistema)
- **Comercio:** image (logo), phone, address, open, schedule

**DELIVERY:**
- **Delivery Company:** 9 campos requeridos + photo_users (required) + campos opcionales (igual que COMMERCE: image, phone, address, open, schedule)
- **Delivery Agent:** 7 campos requeridos + photo_users (required), vehicle_type, license_number
- **Puede ser independiente:** company_id = null

**IMPORTANTE:** Ver backend README.md secci√≥n "üìã DATOS REQUERIDOS POR ACCI√ìN Y ROL" para detalles completos.

### Navegaci√≥n por Niveles

**MainRouter maneja navegaci√≥n multi-nivel:**
```dart
// Nivel 0: Comprador
if (_selectedLevel == 0) {
  switch (_bottomNavIndex) {
    case 0: return const ProductsPage();
    case 1: return const CartPage();
    case 2: return const OrdersPage();
    case 3: return const RestaurantsPage();
  }
}

// Nivel 1: Comercio
if (_selectedLevel == 1) {
  switch (_bottomNavIndex) {
    case 0: return const CommerceDashboardPage();
    case 1: return const CommerceOrdersPage();
    case 2: return const CommerceInventoryPage();
    case 3: return const CommerceReportsPage();
  }
}
```

---

## MEJORAS CR√çTICAS PENDIENTES

### üî¥ CR√çTICO - Acci√≥n Inmediata (RESUELTOS ‚úÖ)

1. ~~**Implementar TODOs en M√∫ltiples Servicios (CR√çTICO)**~~ ‚úÖ **COMPLETADO**
   - ~~commerce_service.dart~~ ‚úÖ COMPLETADO
   - ~~admin_service.dart~~ ‚úÖ COMPLETADO
   - ~~analytics_service.dart~~ ‚úÖ COMPLETADO
   - ~~payment_service.dart~~ ‚úÖ COMPLETADO
   - ~~delivery_service.dart~~ ‚úÖ COMPLETADO
   - ~~chat_service.dart~~ ‚úÖ COMPLETADO
   - ~~location_service.dart~~ ‚úÖ COMPLETADO
   - ~~notification_service.dart~~ ‚úÖ COMPLETADO
   - ~~`affiliate_service.dart`~~ (EXCLUIDO DEL MVP)
   - ~~`transport_service.dart`~~ (EXCLUIDO DEL MVP)
   - Todos los servicios MVP usan llamadas reales a API

2. ~~**Eliminar C√≥digo Comentado**~~ ‚úÖ **COMPLETADO**
   - ~330 l√≠neas comentadas eliminadas de `main.dart`

3. **Implementar Internacionalizaci√≥n (i18n)** (PENDIENTE)
   - M√∫ltiples strings hardcodeados en espa√±ol
   - **Archivos afectados:** `settings_page_2.dart` y otros
   - **Recomendaci√≥n:** Usar `flutter_localizations` o `intl`

### üü° ALTO - Pr√≥ximas Semanas

4. **Implementar Subida de Im√°genes**
   - `commerce_data_service.dart` l√≠nea 204: `TODO: Implementar subida de imagen`
   - `commerce_data_page.dart` l√≠nea 119: `TODO: Implementar selecci√≥n de imagen`

5. **Optimizar Performance**
   - Implementar lazy loading de im√°genes
   - Cachear respuestas de API
   - Optimizar re-renders

6. **Mejorar Manejo de Errores**
   - Manejo global de errores
   - Retry autom√°tico para requests fallidos
   - Mensajes de error m√°s descriptivos

---

## UI/UX

### Temas y Colores

**Usar AppColors:**
```dart
import '../../utils/app_colors.dart';

Container(
  color: AppColors.blue,
  child: Text(
    'Texto',
    style: TextStyle(color: AppColors.white),
  ),
)
```

**Temas:**
- Light theme configurado
- Dark theme configurado
- Modo autom√°tico seg√∫n sistema

### Componentes Reutilizables

**Crear widgets reutilizables:**
```dart
// lib/features/widgets/product_card.dart
class ProductCard extends StatelessWidget {
  final Product product;
  
  const ProductCard({super.key, required this.product});
  
  @override
  Widget build(BuildContext context) {
    return Card(
      child: Column(
        children: [
          Image.network(product.image),
          Text(product.name),
          Text('\$${product.price}'),
        ],
      ),
    );
  }
}
```

---

## TESTING

### Estructura de Tests

**Tests unitarios:**
```dart
// test/services/cart_service_test.dart
void main() {
  group('CartService', () {
    test('addToCart agrega producto correctamente', () {
      final service = CartService();
      final item = CartItem(id: 1, nombre: 'Test', precio: 10.0, quantity: 1);
      
      service.addToCart(item);
      
      expect(service.items.length, 1);
      expect(service.items.first.id, 1);
    });
  });
}
```

**Tests de integraci√≥n:**
```dart
// test/integration/order_flow_test.dart
void main() {
  testWidgets('Usuario puede crear orden completa', (tester) async {
    // Setup
    // Ejecutar flujo
    // Verificar resultado
  });
}
```

### Ejecutar Tests

```bash
# Todos los tests
flutter test

# Tests espec√≠ficos
flutter test test/services/cart_service_test.dart

# Con coverage
flutter test --coverage
```

---

## MEJORES PR√ÅCTICAS

### C√≥digo

1. ‚úÖ **SIEMPRE usar AppConfig para URLs**
2. ‚úÖ **SIEMPRE usar AuthHelper para headers**
3. ‚úÖ **Manejar errores apropiadamente**
4. ‚úÖ **Usar try-catch en operaciones async**
5. ‚úÖ **Validar datos antes de usar**
6. ‚úÖ **Documentar m√©todos complejos con `///`**

### Performance

1. ‚úÖ **Usar `const` constructors cuando sea posible**
2. ‚úÖ **Evitar rebuilds innecesarios con `Consumer` selectivo**
3. ‚úÖ **Usar `ListView.builder` para listas largas**
4. ‚úÖ **Cachear im√°genes con `cached_network_image`**
5. ‚úÖ **Lazy load de rutas y widgets pesados**

### Seguridad

1. ‚úÖ **NUNCA hardcodear tokens o secrets**
2. ‚úÖ **Usar `flutter_secure_storage` para datos sensibles**
3. ‚úÖ **Validar input del usuario**
4. ‚úÖ **Sanitizar datos antes de enviar a API**
5. ‚úÖ **Manejar tokens expirados apropiadamente**

### UI/UX

1. ‚úÖ **Mostrar loading states**
2. ‚úÖ **Manejar estados de error**
3. ‚úÖ **Feedback visual para acciones del usuario**
4. ‚úÖ **Mensajes de error claros y √∫tiles**
5. ‚úÖ **Dise√±o responsive**

---

## CONFIGURACI√ìN

### Variables de Entorno

**Archivo `.env`:**
```env
API_URL_LOCAL=http://192.168.27.12:8000
API_URL_PROD=https://zonix.uniblockweb.com
```

**Uso en c√≥digo:**
```dart
import 'package:flutter_dotenv/flutter_dotenv.dart';

final apiUrl = dotenv.env['API_URL_LOCAL'] ?? 'http://localhost:8000';
```

### AppConfig

**Configuraci√≥n centralizada:**
```dart
class AppConfig {
  static const String apiUrlLocal = 'http://192.168.27.12:8000';
  static const String apiUrlProd = 'https://zonix.uniblockweb.com';
  
  static String get apiUrl {
    const bool isProduction = bool.fromEnvironment('dart.vm.product');
    return isProduction ? apiUrlProd : apiUrlLocal;
  }
  
  static const String wsUrlLocal = 'ws://192.168.0.101:6001';
  static const String wsUrlProd = 'wss://zonix.uniblockweb.com';
  
  static String get wsUrl {
    const bool isProduction = bool.fromEnvironment('dart.vm.product');
    return isProduction ? wsUrlProd : wsUrlLocal;
  }
}
```

---

## DEPENDENCIAS PRINCIPALES

### State Management
- `provider: ^6.1.2` - State management

### HTTP y Networking
- `http: ^1.2.2` - Cliente HTTP
- `pusher_channels_flutter` - Tiempo real (Pusher). No usar WebSocket directo; sistema principal es Firebase + Pusher

### Storage
- `flutter_secure_storage: ^9.2.2` - Almacenamiento seguro
- `shared_preferences: ^2.3.2` - Preferencias locales

### Autenticaci√≥n
- `google_sign_in: ^6.2.1` - Google Sign-In

### UI
- `flutter_svg: ^2.0.10+1` - SVG
- `google_fonts: ^6.2.1` - Fuentes de Google
- `shimmer: ^2.0.0` - Loading shimmer

### Utilidades
- `geolocator: ^13.0.1` - Geolocalizaci√≥n
- `image_picker: ^1.1.2` - Selecci√≥n de im√°genes
- `logger: ^2.4.0` - Logging
- `intl: ^0.19.0` - Internacionalizaci√≥n

---

## REFERENCIAS

- **Flutter Docs:** https://flutter.dev/docs
- **Dart Docs:** https://dart.dev/guides
- **Provider Docs:** https://pub.dev/packages/provider
- **HTTP Package:** https://pub.dev/packages/http

---

## PROBLEMAS CONOCIDOS Y SOLUCIONES

### Problema: C√≥digo Comentado Extenso

**Ubicaci√≥n:** `lib/main.dart`  
**Problema:** ~330 l√≠neas de c√≥digo comentado  
**Soluci√≥n:** Eliminar c√≥digo legacy comentado, usar control de versiones

### ~~Problema: TODOs Sin Implementar (CR√çTICO)~~ ‚úÖ RESUELTO

**Ubicaci√≥n:** M√∫ltiples servicios en `lib/features/services/`  
**Estado:** ‚úÖ **COMPLETADO** - commerce, payment, delivery, chat, admin, analytics, location, notification implementados con llamadas reales a API  
**Soluci√≥n aplicada:** Todos los servicios MVP siguen el patr√≥n de servicios existentes con API real

### Problema: Strings Hardcodeados

**Ubicaci√≥n:** M√∫ltiples archivos  
**Problema:** No hay internacionalizaci√≥n  
**Soluci√≥n:** Implementar i18n con `flutter_localizations`

---

## AN√ÅLISIS EXHAUSTIVO DEL PROYECTO

### Documento de An√°lisis

**Ubicaci√≥n:** `ANALISIS_EXHAUSTIVO.md` (ra√≠z del proyecto)  
**Versi√≥n de Prompts:** 2.0 - Basada en Experiencia Real

Este documento contiene un an√°lisis exhaustivo completo del proyecto realizado en Diciembre 2024, cubriendo todas las √°reas:
1. Arquitectura y Estructura
2. C√≥digo y Calidad
3. L√≥gica de Negocio
4. Base de Datos
5. Seguridad (OWASP Top 10 completo)
6. Performance (bottlenecks, quick wins, m√©tricas)
7. Testing (cobertura, estrategia, plan de mejora)
8. Frontend (UI/UX, componentes, state management, routing)
9. Integraci√≥n con Backend
10. DevOps e Infraestructura
11. Documentaci√≥n
12. **Verificaci√≥n de Coherencia entre Archivos** ‚≠ê NUEVO
13. Estado y Mantenibilidad
14. Oportunidades y Mejoras

### Realizar An√°lisis Exhaustivo

Cuando se solicite un an√°lisis exhaustivo del proyecto, seguir los **PROMPTS COMPLETOS PARA AN√ÅLISIS EXHAUSTIVO v2.0** disponibles. Estos prompts proporcionan un marco estructurado para an√°lisis profundos con verificaci√≥n de coherencia.

**PROMPT MAESTRO - AN√ÅLISIS COMPLETO v2.0:**

```
Realiza un AN√ÅLISIS COMPLETO Y EXHAUSTIVO del proyecto Zonix Eats Frontend.

INSTRUCCIONES GENERALES:
- Explora TODA la estructura del proyecto sin dejar √°reas sin revisar
- Lee y analiza los archivos m√°s importantes de cada m√≥dulo
- Identifica patrones, anti-patrones y code smells
- Proporciona ejemplos concretos de c√≥digo cuando sea relevante (formato: archivo:l√≠nea)
- Prioriza hallazgos por criticidad (cr√≠tico, alto, medio, bajo)
- Sugiere mejoras espec√≠ficas y accionables con estimaci√≥n de esfuerzo
- **VERIFICA COHERENCIA** entre diferentes archivos de documentaci√≥n (README, .cursorrules, etc.)

METODOLOG√çA DE AN√ÅLISIS:

FASE 1: EXPLORACI√ìN INICIAL
1. Mapear estructura completa de directorios y archivos
2. Identificar archivos de configuraci√≥n clave (pubspec.yaml, .env, etc.)
3. Leer archivos de documentaci√≥n principales (README.md, .cursorrules, CHANGELOG.md, etc.)
4. Identificar stack tecnol√≥gico completo y versiones
5. Mapear dependencias principales y secundarias

FASE 2: AN√ÅLISIS PROFUNDO POR √ÅREA
Realiza an√°lisis exhaustivo en estas secciones:
1. ARQUITECTURA Y ESTRUCTURA
   - Mapea TODA la estructura de directorios y archivos (177 archivos Dart)
   - Identifica patr√≥n arquitect√≥nico (Feature-based + Provider)
   - Lista stack tecnol√≥gico completo (Flutter, Dart, dependencias)
   - Analiza configuraci√≥n y entorno

2. C√ìDIGO Y CALIDAD
   - Revisa consistencia de estilo y convenciones Dart/Flutter
   - Analiza complejidad ciclom√°tica
   - Detecta duplicaci√≥n de c√≥digo (DRY violations)
   - Identifica code smells (God Object en main.dart, TODOs sin implementar)
   - Eval√∫a aplicaci√≥n de principios SOLID

3. L√ìGICA DE NEGOCIO
   - Identifica modelos de datos y sus relaciones
   - Mapea flujos de trabajo principales (carrito, √≥rdenes, chat)
   - Analiza servicios y su organizaci√≥n (TODOs MVP completados: commerce, payment, delivery, chat, admin, analytics, location, notification)
   - Revisa integraci√≥n con backend

4. BASE DE DATOS (Modelos y Estructura)
   - Mapea modelos de datos (Order, Product, Commerce, etc.)
   - Analiza estructura de datos en frontend
   - Revisa serializaci√≥n/deserializaci√≥n (fromJson/toJson)

5. SEGURIDAD
   - Analiza almacenamiento seguro (flutter_secure_storage)
   - Eval√∫a manejo de tokens y autenticaci√≥n
   - Revisa validaci√≥n de input del usuario
   - Analiza protecci√≥n de datos sensibles

6. PERFORMANCE
   - Analiza bundle size y code splitting
   - Eval√∫a tiempo de carga inicial
   - Revisa renderizado y re-renders innecesarios
   - Analiza optimizaci√≥n de im√°genes y assets
   - Eval√∫a caching de datos

7. TESTING
   - Analiza cobertura de tests Flutter
   - Eval√∫a estrategia de testing
   - Revisa calidad de tests existentes
   - Identifica √°reas sin cobertura

8. FRONTEND
   - Analiza UI/UX y componentes reutilizables
   - Eval√∫a state management (Provider pattern)
   - Revisa routing y navegaci√≥n (MainRouter multi-nivel)
   - Analiza optimizaci√≥n (lazy loading, memo, etc.)
   - Eval√∫a accesibilidad (a11y)

9. INTEGRACI√ìN CON BACKEND
   - Analiza consumo de APIs (232 endpoints verificados en backend)
   - Revisa manejo de errores de API
   - Eval√∫a loading states y optimistic updates
   - Analiza Firebase + Pusher y tiempo real

10. DEVOPS E INFRAESTRUCTURA
    - Analiza build y bundling
    - Revisa configuraci√≥n de ambientes
    - Eval√∫a dependencias y vulnerabilidades

11. DOCUMENTACI√ìN
    - Eval√∫a README y documentaci√≥n t√©cnica
    - Revisa comentarios en c√≥digo
    - Identifica documentaci√≥n faltante

12. ESTADO Y MANTENIBILIDAD
    - Identifica funcionalidades completadas
    - Analiza estado de servicios (TODOs MVP completados)
    - Eval√∫a technical debt (c√≥digo comentado, etc.)
    - Calcula m√©tricas del proyecto

13. OPORTUNIDADES Y MEJORAS
    - Identifica quick wins (TODOs MVP completados; i18n, subida im√°genes pendientes)
    - Prioriza refactorizaciones (limpiar c√≥digo comentado)
    - Sugiere optimizaciones cr√≠ticas
    - Crea roadmap t√©cnico

Para cada secci√≥n, proporciona:
- An√°lisis detallado con hallazgos espec√≠ficos (con ubicaciones de archivos)
- Fortalezas identificadas (‚úÖ)
- Debilidades y problemas encontrados (‚ö†Ô∏è o ‚ùå)
- Ejemplos concretos de c√≥digo o referencias a archivos (usar formato archivo:l√≠nea)
- Recomendaciones priorizadas con:
  - Impacto estimado (Alto/Medio/Bajo)
  - Esfuerzo estimado (horas/semanas)
  - Prioridad (Cr√≠tica/Alta/Media/Baja)
- M√©tricas cuantificables cuando sea posible

FORMATO DE SALIDA:
1. RESUMEN EJECUTIVO (al inicio):
   - Estado general del proyecto
   - Fortalezas principales (top 5)
   - √Åreas de mejora cr√≠ticas (top 5)
   - Score de mantenibilidad (X/10)
   - Recomendaci√≥n general (Production Ready / Necesita Mejoras / Cr√≠tico)

2. AN√ÅLISIS POR SECCI√ìN con subsecciones numeradas
3. CHECKLIST DE VERIFICACI√ìN FINAL antes de considerar completo
```

**PROMPTS ESPEC√çFICOS DISPONIBLES (v2.0):**

Adem√°s del prompt maestro, existen prompts espec√≠ficos para an√°lisis profundos:
- **PROMPT 1:** An√°lisis Arquitect√≥nico y Estructural
- **PROMPT 2:** An√°lisis de C√≥digo y Calidad
- **PROMPT 3:** An√°lisis de L√≥gica de Negocio
- **PROMPT 4:** An√°lisis de Base de Datos (modelos y estructura)
- **PROMPT 5:** An√°lisis de Seguridad (OWASP Top 10 completo con checklist)
- **PROMPT 6:** An√°lisis de Performance (bottlenecks, quick wins, m√©tricas)
- **PROMPT 7:** An√°lisis de Testing (cobertura, estrategia, plan de mejora)
- **PROMPT 8:** An√°lisis de Frontend (UI/UX, componentes, state management, routing)
- **PROMPT 10:** An√°lisis de DevOps e Infraestructura
- **PROMPT 11:** An√°lisis de Documentaci√≥n
- **PROMPT 12:** ‚≠ê **Verificaci√≥n de Coherencia entre Archivos** (NUEVO - CR√çTICO)
- **PROMPT 13:** An√°lisis de Estado y Mantenibilidad
- **PROMPT 14:** An√°lisis de Oportunidades y Mejoras (con roadmap t√©cnico)

**Prompts Espec√≠ficos Adicionales:**
- An√°lisis R√°pido pero Completo (versi√≥n concisa)
- An√°lisis para Refactorizaci√≥n
- An√°lisis para Onboarding
- An√°lisis de Seguridad Profundo
- An√°lisis de Performance Profundo
- An√°lisis de Arquitectura Profundo
- An√°lisis de L√≥gica de Negocio Profundo

**Ver:** `prompts_analisis_completo.txt` (si existe) para prompts completos y detallados v2.0.

### Checklist de Verificaci√≥n Final

Antes de considerar el an√°lisis completo, verificar:
- ‚úÖ Todas las 14 secciones principales fueron analizadas
- ‚úÖ Se verific√≥ coherencia entre diferentes archivos de documentaci√≥n
- ‚úÖ Se identificaron y corrigieron discrepancias encontradas
- ‚úÖ Las m√©tricas mencionadas son consistentes en toda la documentaci√≥n
- ‚úÖ Se incluyeron m√©tricas cuantificables cuando fue posible
- ‚úÖ Se proporcionaron estimaciones de esfuerzo para mejoras sugeridas
- ‚úÖ Se complet√≥ el checklist OWASP Top 10 completo
- ‚úÖ Se identificaron quick wins (alto impacto, bajo esfuerzo)
- ‚úÖ Se cre√≥ un roadmap t√©cnico con corto/medio/largo plazo

### Actualizar An√°lisis

**Cu√°ndo actualizar:**
- Despu√©s de cambios arquitect√≥nicos importantes
- Despu√©s de implementar mejoras cr√≠ticas
- Cada 3-6 meses o cuando se solicite
- Antes de releases mayores

**C√≥mo actualizar:**
1. Revisar cambios desde √∫ltimo an√°lisis
2. Ejecutar an√°lisis exhaustivo siguiendo prompts
3. Actualizar `ANALISIS_EXHAUSTIVO.md`
4. Actualizar esta secci√≥n con fecha de √∫ltima actualizaci√≥n

---

**√öltima actualizaci√≥n:** 11 Febrero 2025 
**Mantener este archivo actualizado con cambios arquitect√≥nicos importantes**

---

## L√ìGICA DE NEGOCIO - MVP (Actualizado Febrero 2025)

### Decisiones Clave del MVP

1. **Carrito:** NO puede haber productos de diferentes comercios (uni-commerce)
2. **Validaci√≥n de Precio:** Recalcular y validar contra total enviado
3. **Stock:** AMBAS opciones (`available` Y `stock_quantity`) - Validar siempre available, si tiene stock_quantity validar cantidad
4. **Delivery:** Sistema completo (propio, empresas, independientes) + Asignaci√≥n aut√≥noma con expansi√≥n de √°rea
5. **Eventos:** Firebase + Pusher (NO WebSocket)
6. **Perfiles:** Datos m√≠nimos (USERS) vs completos (COMMERCE, DELIVERY)
7. **photo_users:** Required estricto (bloquea creaci√≥n de orden)
8. **Geolocalizaci√≥n Comercios:** B√∫squeda inicial 1-1.5km, expansi√≥n autom√°tica a 4-5km
9. **Asignaci√≥n Delivery:** Aut√≥noma con expansi√≥n autom√°tica de √°rea (1-1.5km ‚Üí 4-5km ‚Üí continua)
10. **Cancelaci√≥n:** L√≠mite 5 minutos O hasta validaci√≥n de pago
11. **Reembolsos:** Manual (no autom√°tico)

### Direcciones y Geolocalizaci√≥n

**USERS tiene 2 direcciones:**
1. **Predeterminada (Casa):** `is_default = true` en tabla `addresses`
   - **Uso:** Base para b√∫squeda de comercios por geolocalizaci√≥n
   - **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n
2. **Entrega (Pedido):** Puede ser diferente, se guarda temporalmente o como nueva direcci√≥n
   - **Ubicaci√≥n:** GPS + inputs y selects para mayor precisi√≥n

**B√∫squeda de Comercios por Geolocalizaci√≥n:**
- **Rango inicial:** 1-1.5 km desde direcci√≥n predeterminada del usuario
- **Expansi√≥n autom√°tica:** Si no hay comercios abiertos, expande autom√°ticamente a 4-5 km
- **Expansi√≥n manual:** Usuario puede ampliar rango si desea buscar m√°s lejos
- **C√°lculo:** Haversine para calcular distancia entre coordenadas GPS

**Onboarding comercio (paso 4):**
- Crear comercio: `CommerceDataService.createCommerceForExistingProfile(profileId, data)` ‚Üí `POST /api/profiles/add-commerce`. Devuelve `data.id` (commerce_id).
- **schedule:** Enviar siempre como **string** (backend valida string). Si es Map: `schedule.isEmpty ? '' : jsonEncode(_commerceSchedule)`.
- Direcci√≥n del establecimiento: `AddressService.createAddress(..., role: 'commerce', commerceId: commerceId)` sin profile_id en el body cuando hay commerceId.

### üí∞ MODELO DE NEGOCIO - RESUMEN

**Costos y Precios:**
- **Costo Delivery:** H√≠brido (Base fija + Por distancia) - Cliente paga
- **Membres√≠a/Comisi√≥n:** Membres√≠a mensual obligatoria (base) + Comisi√≥n % sobre ventas del mes (extra)
- **M√≠nimo pedido:** No hay m√≠nimo
- **Tarifa servicio:** No hay
- **Propinas:** No permitidas

**Pagos:**
- **M√©todos:** Todos (efectivo, transferencia, tarjeta, pago m√≥vil, digitales)
- **Qui√©n recibe:** Comercio directamente
- **Manejo:** Tiempo real
- **Pago a delivery:** Del comercio (despu√©s de recibir pago del cliente) ‚Üí **Delivery recibe 100% del delivery_fee** (Opci√≥n A confirmada)

**L√≠mites:**
- **Distancia m√°xima:** 60 minutos de tiempo estimado
- **Quejas/Disputas:** Sistema de tickets con admin

**Ver backend README.md secci√≥n "üí∞ MODELO DE NEGOCIO" para detalles completos.**

### Penalizaciones y Tiempos L√≠mite

**Cancelaciones:** Penalizaciones si exceden l√≠mites (5 cancelaciones/rechazos)
**Tiempos l√≠mite:** 5 minutos para subir/validar comprobante (cancelaci√≥n autom√°tica)
**Rating:** Obligatorio, separado (comercio/delivery), no editable
**Promociones:** Manual (comercio/admin), c√≥digo o autom√°tico
**M√©todos de pago:** Solo UN m√©todo por orden (no mitad y mitad)
**Delivery no encontrado:** Contin√∫a buscando, no cancela orden

### Campos Requeridos por Rol

**USERS:** firstName, lastName, phone, photo_users (required)
**COMMERCE:** 7 campos requeridos + 16 opcionales
**DELIVERY COMPANY:** 9 campos requeridos + campos opcionales (igual estructura que COMMERCE)
**DELIVERY AGENT:** 7 campos requeridos + campos opcionales

**IMPORTANTE:** Ver backend README.md secci√≥n completa "üìã DATOS REQUERIDOS POR ACCI√ìN Y ROL" para detalles espec√≠ficos de cada campo.
